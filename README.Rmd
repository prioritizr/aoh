---
output:
  rmarkdown::github_document:
    html_preview: no
---

```{r, include = FALSE}
knitr::opts_chunk$set(fig.path = "man/figures/README-", fig.align = "center",
                      fig.height = 4.5, fig.width = 4.5)
```

<!--- README.md is generated from README.Rmd. Please edit that file -->

## aoh: Area of Habitat

[![lifecycle](https://img.shields.io/badge/Lifecycle-stable-brightgreen.svg)](https://lifecycle.r-lib.org/articles/stages.html)
[![R-CMD-check-Ubuntu](https://img.shields.io/github/workflow/status/prioritizr/aoh/Ubuntu/master.svg?label=Ubuntu)](https://github.com/prioritizr/aoh/actions)
[![R-CMD-check-Windows](https://img.shields.io/github/workflow/status/prioritizr/aoh/Windows/master.svg?label=Windows)](https://github.com/prioritizr/aoh/actions)
[![R-CMD-check-Mac-OSX](https://img.shields.io/github/workflow/status/prioritizr/aoh/Mac%20OSX/master.svg?label=Mac%20OSX)](https://github.com/prioritizr/aoh/actions)
[![Coverage Status](https://codecov.io/github/prioritizr/aoh/coverage.svg?branch=master)](https://codecov.io/github/prioritizr/aoh?branch=master)
[![CRAN_Status_Badge](http://www.r-pkg.org/badges/version/aoh)](https://CRAN.R-project.org/package=aoh)

```{r, include = FALSE}
devtools::load_all()
```

### Overview

Area of Habitat (AOH) maps aim to delineate the spatial distribution of suitable habitat for a species ([Brooks *et al.* 2019](https://doi.org/10.1016/j.tree.2019.06.009)). They are used to help understand the impacts of habitat loss on species, and prioritize areas for conservation (e.g. [Tracewski *et al.* 2016](https://doi.org/10.1111/cobi.12715); [Rondinini *et al.* 2005](https://doi.org/10.1111/j.1523-1739.2005.00204.x)). These maps are generally produced by obtaining geographic range data for a species, and then removing areas that do not contain suitable habitat or occur outside the known altitudinal limits for the species ([Brooks *et al.* 2019](https://doi.org/10.1016/j.tree.2019.06.009)). To help make these maps accessible, the _aoh R_ package provides routines for automatically creating Area of Habitat data based on the [International Union for Conservation of Nature (IUCN) Red List of Threatened Species](https://www.iucnredlist.org/). After manually downloading species range data from the [IUCN Red List](https://www.iucnredlist.org/resources/spatial-data-download), users can import them (using `read_spp_range_data()`) and then use them to create Area of Habitat data (using `create_spp_aoh_data()`). Global elevation and habitat classification data ([Amatulli *et al.* 2018](https://doi.org/10.1038/sdata.2018.40); [Jung *et al.* 2020](https://doi.org/10.1038/s41597-020-00599-8)) are automatically downloaded, and data on species' habitat preferences and altitudinal limits are obtained automatically using the [IUCN Red List API](https://apiv3.iucnredlist.org/). Since accessing the IUCN Red List requires a token, users may need to [obtain a token](https://apiv3.iucnredlist.org/api/v3/token) and update their _R_ configuration to recognize the token (see installation instructions below for details).

### Installation

#### Package installation

The [latest developmental version of the _aoh R_ package](https://github.com/prioritizr/aoh) can be installed using the following _R_ code. Please note that it requires the [_sf_](https://CRAN.R-project.org/package=sf) and [_terra_](https://CRAN.R-project.org/package=terra) _R_ packages which may require additional software to be installed. If you encounter problems installing these dependencies, please consult their installation instructions.

```{r, eval = FALSE}
if (!require(remotes)) install.packages("remotes")
remotes::install_github("prioritizr/aoh")
```

#### Accessing the IUCN Red List API

After installing the _aoh R_ package, you will need to obtain a token for the [IUCN Red List API](https://apiv3.iucnredlist.org/) (if you do not have one already). To achieve this, please visit the IUCN website (see <https://apiv3.iucnredlist.org/api/v3/token>) and fill out the form to apply for a token. You should then receive a token shortly after completing the form (but not immediately). After receiving a token, please open the `.Renviron` file on your computer (e.g. using `usethis::edit_r_environ()`). Next, please add the following text to the file (replacing the string with the token) and save the file:

```
IUCN_REDLIST_KEY="your_actual_token_not_this_string"
```

Please restart your R session. You should now be able to access the IUCN Red List API. To verify this, please try running the following _R_ code and -- assuming everything works correctly -- you should see the current version of the IUCN Red List:

```{r, eval = FALSE}
# verify access to IUCN Red List API
rredlist::rl_version()
```

If these instructions did not work, please consult the documentation for the [_rredlist_](https://CRAN.R-project.org/package=rredlist) _R_ package for further details.

### Usage

Here we provide a short introduction to the _aoh R_ package. In this example, we will generate Area of Habitat data for the following Iberian species: Pyrenean brook salamander (_Calotriton asper_), Iberian frog (_Rana iberica_), western spadefoot toad (_Pelobates cultripes_), and golden striped salamnader (_Chioglossa lusitanica_). To start off, we will load the package. We will also load the [_rappdirs_](https://CRAN.R-project.org/package=rappdirs) _R_ package to cache data, and the [_terra_](https://CRAN.R-project.org/package=terra) and [_ggplot2_](https://CRAN.R-project.org/package=ggplot2) _R_ packages to visualize results.

```{r}
# load packages
library(aoh)
library(terra)
library(rappdirs)
library(ggplot2)
```

Now we will import range data for the species. Although users would typically obtain range data from the [International Union for Conservation of Nature (IUCN) Red List of Threatened Species](https://www.iucnredlist.org/), here we will use built-in species range data that distributed with the package for convenience. **Please note that these data were not obtained from the IUCN Red List, and were manually generated using occurrence records from the [Global Biodiversity Information Facility](https://www.gbif.org/).**

```{r}
# find file path for data
path <- system.file("extdata", "EXAMPLE_SPECIES.zip", package = "aoh")

# import data
spp_range_data <- read_spp_range_data(path)

# preview data
print(spp_range_data)
```

Next, we will generate Area of Habitat data for the species. To achieve this, the package will (i) automatically download global elevation and habitat classification data (from [Amatulli *et al.* 2018](https://doi.org/10.1038/sdata.2018.40); [Jung *et al.* 2020](https://doi.org/10.1038/s41597-020-00599-8)), (ii) automatically download information on the altitudinal limits and habitat preferences of the species from the IUCN Red List (per the taxon identifiers in  the `id_no` column), and (iii) cross-reference this information to identify suitable habitat inside the geographic range of each species (following [Brooks *et al.* 2019](https://doi.org/10.1016/j.tree.2019.06.009)). We also specify a folder to cache the downloaded datasets so that we won't need to re-downloaded again during subsequent runs.

```{r, message = FALSE}
# specify cache directory
cache_dir <- user_data_dir("aoh")

# specify folder to save Area of Habitat data
## although we use a temporary directory here to avoid polluting your
## with examples files, you would normally specify the folder
## on your computer where you want to save data
output_dir <- tempdir()

# generate Area of Habitat data
## note that this function might take a complete because it will need to
## download the global habitat and elevation data that first time you run it.
spp_aoh_data <- create_spp_aoh_data(
  spp_range_data, output_dir = output_dir, cache_dir = cache_dir
)
```

While running the code, we see that it displayed a message telling us that certain habitat classes were not available (i.e. "5.18", "7.1", and "7.2"). **This is fine. It is not an error.** The reason we see this message is because although the global habitat dataset contains the majority of [IUCN habitat classes](https://www.iucnredlist.org/resources/habitat-classification-scheme) for terrestrial environments, it does not contain every single IUCN habitat class (see [Jung *et al.* 2020](https://doi.org/10.1038/s41597-020-00599-8) for details). Upon checking the [IUCN habitat classes](https://www.iucnredlist.org/resources/habitat-classification-scheme), we can see that these classes correspond to caves and other subterranean environments. Although failing to account for such habitats could potentially be an issue, here we will assume that accounting for the species' non-subterranean habitats is sufficient to describe their spatial distribution (similar to [Ficetola *et al.* 2015](https://doi.org/10.1111/ddi.12296)).

```{r}
# preview results
## resulting dataset is a simple features (sf) object containing
## spatial geometries for cleaned versions of the range data
## (in the geometry column) and the following additional columns:
##
## - id_no            : IUCN Red List taxon identifier
## - seasonal         : integer identifier for seasonal distributions
## - full_habitat_code: All IUCN Red List codes for suitable habitat classes
##                      (multiple codes are delimited using "|" symbols)
## - habitat_code     : IUCN Red List codes for suitable habitat classes
##                      used to create AOH maps
## - elevation_lower  : lower limit for the species on IUCN Red List
## - elevation_upper  : upper limit for the species on IUCN Red List
## - xmin             : minimum x-coordinate for Area of Habitat data
## - xmax             : maximum x-coordinate for Area of Habitat data
## - ymin             : minimum y-coordinate for Area of Habitat data
## - ymax             : maximum y-coordinate for Area of Habitat data
## - path             : file path for Area of Habitat data (GeoTIFF format)
##
## since data obtained from the IUCN Red List cannot be redistributed,
## we will not show all the columns in this object
##
## N.B. you can view all columns on your computer with: print(spp_aoh_data)
print(spp_aoh_data[, c("id_no", "seasonal", "path")])
```

After generating the Area of Habitat data, we can import them.

```{r}
# import the Area of Habitat data
## since the data for each species have a different spatial extent
## (to reduce file sizes), we will import each dataset separately in a list
spp_aoh_rasters <- lapply(spp_aoh_data$path, rast)

# preview raster data
print(spp_aoh_rasters)
```

Finally, let's create some maps to compare the range data with the Area of habitat data. Although we could create these maps manually (e.g. using the [_ggplot2_](https://CRAN.R-project.org/package=rappdirs) _R_ package), we will use a plotting function distributed with the _aoh R_ package for convenience.

```{r, message = FALSE, warning = FALSE, dpi = 200, fig.width = 5.5, fig.height = 4, out.width = ifelse(isTRUE(knitr:::is_html_output(excludes = c("markdown"))), "60%", "90%")}
# create maps
map <-
  plot_spp_aoh_data(spp_aoh_data, zoom = 6, maptype = "toner-background") +
  scale_fill_viridis_c() +
  scale_color_manual(values = c("range" = "red")) +
  scale_size_manual(values = c("range" = 0.5)) +
  theme(
    axis.title = element_blank(),
    axis.text = element_text(size = 6),
    strip.text = element_text(color = "white"),
    strip.background = element_rect(fill = "black", color = "black")
  )

# display maps
print(map)
```

### Citation

Please cite the _aoh R_ package and the underlying datasets used to produce Area of Habitat data.

```{r, echo  = FALSE, result = "asis", comment = ""}
citation("aoh")
```
